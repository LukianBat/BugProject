# На sdk надейся и сам не плошай: Проблема вложенных скроллов в BottomSheetBehavior

<----------------картинка------------------->

Наверное, каждый любуясь красивыми и магически плавно съезжающими в разные стороны окошками, тулбарами и остальными вьюхами, задумывался как это работает, наверное, даже что-то читал про CoordianatorLayout, про различные Behaivor, которые позволяют создавать буквально волшебство на андроидовских вьюхах. Конечно, можно писать кастомные вьюхи, с нужныи поведением, которое может быть ограничено только твоим воображением или твоими знаниями в Android разработке. Помимо этого, есть ещё одно ограничение - время, не будешь же ты писать кастомную вьюху на хакатоне, в горящем по срокам проекте, а написанные зараннее решения с кастомными вьюхами, могут быть освоены не за самый короткий срок членами команды. Именно тогда приходит самое простое и самое логичное решение проблемы - не выпендриваемся, используем стандартные инструменты Android, там же смышленные ребята сидят, всё будет в шоколаде (ну или в других сладостях андроида). Но не всё так просто, тут и начинается моё близкое знакомство с магией таких ребят, как CoordinatorLayout, BottomSheetBehavior.

## Первая встреча

Передо мной стояла задача сделать несложный функционал с вложенной прокруткой, состоящей из горизонтального RecyclerView, ScrollView и CoordinatorLayout, именно он позволяет, ориентируясь на Behavior-ы вложенных вьюх, вытворять такие фигуры высшего пилотажа, как плавные произвольные сдвиги разлчных вью. 

<----------------анимашка------------------->

Разложим по полочкам: делаем корневой CoordinatorLayout, внутри которого, находится RecyclerView, с прописанным поведением из библиотеки android.material *BottomSheetBehavior*, что позволит нашему ресайклеру, выезжать снизу корневого вью или обратно туда сворачиваться. Внутри item-ов каждого, находится TextView - заголовок item-а, и NestedScrollView, с различным наполнением (допустим тот же TextView). Почему NestedScrollView? Потому что он, согласно официальной документации Android, выполняет ту же функцию, что ScrollView, но помимо этого поддерживает вложенную прокрутку, как со стороны родительской, так и со стороны дочерней вьюхи, по умолчанию.

Накидали вьюхи на layout, написали своих наследников RecyclerView.Adapter и RecyclerView.ViewHolder, сделали модели данных, заглушки, кажется всё готово..

Итак, камера, мотор, и.. Всё работает? Шторка выезжает и сворачивается, NestedScrollView крутится, в чём подвох? Перелистываем recycler на другой item, пробуем скроллить.. Не работает.. Прокрутим ещё на несколько item-ов дальше, снова работает, и так продолжается с точной периодичностью в несколько item-ов. Кто знаком с идеей работы RecyclerView, уже знает в чём дело - дело в грязных View, которые Recycler переиспользует, чтобы экономить ресурсы смартфона. Но это не совсем то, из-за чего может не скроллится NestedScrollView, начинаем расследование.

## Пробуем отлавливать события
Первое что, пришло мне в голову - посмотреть какие события приходят в рабочем item-е и в нерабочем. Попробуем отлавливать события onScrollChange: 
```kotlin
scrollView.setOnScrollChangeListener { v: NestedScrollView?, scrollX: Int, scrollY: Int, oldScrollX: Int, oldScrollY: Int ->
    Log.i("TAG", "OnScrollChange")
}
```
В первом item всё ок, а вот в остальных тишина.. Тогда пробуем, кое-что поинтереснее, а именно перехватывать касания:
```kotlin
scrollView.rootView.setOnTouchListener { view, motionEvent ->
    Log.i("TAG", motionEvent.toString())
    false
}
```
Картина в логах тут поинтереснее, мы видим, что события касаний логируются, как в рабочем, так и в нерабочем примере, однако если повнимательее посмотреть, то можно увидеть, что в рабочем примере событий больше, чем в нерабочем, следовательно можно придти к выводу, что кто-то или что-то перехватывает наши события, которые так нужны, чтобы сделать скрол.

## Ищем жулика
